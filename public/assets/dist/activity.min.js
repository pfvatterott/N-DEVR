document.addEventListener("DOMContentLoaded",a=>{function b(a,b){return+(Math.round(a+"e"+b)+"e-"+b)}const c=document.getElementById("activityList"),d=document.getElementById("totalDistance"),e=document.getElementById("totalElevationGained"),f=document.getElementById("totalElevationLost");let g=0,h=[],j=0,k=0,l=0,m=0,n=[];a&&console.info("DOM loaded");const o=document.getElementById("mapid");if(o){var p=L.map("mapid").locate({setView:!0,maxZoom:13});L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:"Map data &copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors, Imagery \xA9 <a href=\"https://www.mapbox.com/\">Mapbox</a>",maxZoom:18,id:"mapbox/streets-v11",tileSize:512,zoomOffset:-1,accessToken:"pk.eyJ1IjoicGZ2YXR0ZXJvdHQiLCJhIjoiY2tsODZxOW5uMXo3ZTJ4bW1iN3YwbWpsaCJ9.LGIyO-vQru6dyenUYpZE3A"}).addTo(p);let a=[];const i=(e,f,i,j)=>fetch(`/profile/activity/${e},${f},${i},${j}/biking`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>{p.getBounds();e.json().then(e=>{for(let j=0;j<e.segments.length;j++)if(!a.includes(e.segments[j].id)){a.push(e.segments[j].id);var f=L.Polyline.fromEncoded(e.segments[j].points).getLatLngs();L.polyline(f,{color:"orange",weight:5,opacity:.9,lineJoin:"round",metaDataName:e.segments[j].name,metaDataDistance:e.segments[j].distance,metaDataElevation:e.segments[j].elev_difference,metaDataId:e.segments[j].id}).on("mouseover",a=>{a.target.bringToFront(),initialColor=a.target.options.color,a.target.setStyle({color:"yellow"})}).on("mouseout",a=>{a.target.setStyle({color:initialColor})}).on("click",f=>{m++,fetch(`segment/${f.target.options.metaDataId}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(a=>{a.json().then(a=>{h.push(f.target.options.metaDataId),o(a)})});const e=document.getElementById("deleteButton");e&&e.remove(),g+=b(62137e-8*f.target.options.metaDataDistance,2),d.textContent=g.toFixed(2)+" miles";const j=document.createElement("tr"),k=document.createElement("td"),l=document.createElement("td"),n=document.createElement("td");let p=document.createElement("a"),a=document.createElement("i");p.classList.add("hoverable","btn-floating","btn","deleteButton"),p.setAttribute("data-index",m),a.classList.add("fas","fa-trash-alt","right"),p.setAttribute("id","deleteButton"),p.appendChild(a),k.textContent=f.target.options.metaDataName,l.textContent=Math.round(100*(62137e-8*f.target.options.metaDataDistance))/100+" mi",n.textContent=Math.round(3.28084*f.target.options.metaDataElevation)+" ft",j.appendChild(k),j.appendChild(l),j.appendChild(n),j.append(p),c.appendChild(j);const i=document.getElementById("deleteButton");i&&$(document).on("click",`[data-index=${m}]`,function(a){this.parentElement.remove(),h.pop(),fetch(`segment/${f.target.options.metaDataId}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(a=>{a.json().then(a=>{removeGraphData(a)})}),"green"===f.target.options.color?f.target.setStyle({color:"orange"}):f.target.setStyle({color:"green"}),g-=b(62137e-8*f.target.options.metaDataDistance,2),0>g&&(g=0),d.textContent=g.toFixed(2)+" miles";const e=c.lastElementChild;if(e){let b=document.createElement("a"),a=document.createElement("i");b.classList.add("hoverable","btn-floating","btn","deleteButton"),b.setAttribute("data-index",m-1),a.classList.add("fas","fa-trash-alt","right"),b.setAttribute("id","deleteButton"),b.appendChild(a),e.append(b)}a.preventDefault(),a.stopPropagation(),$(document).off("click",`[data-index=${m}]`),m--}),"orange"===initialColor?f.target.setStyle({color:"green"}):"green"===initialColor?f.target.setStyle({color:"red"}):f.target.setStyle({color:"orange"}),initialColor=f.target.options.color}).addTo(p);L.marker([e.segments[j].start_latlng[0],e.segments[j].start_latlng[1]],{title:`${e.segments[j].name}`}).bindPopup("<b>"+e.segments[j].name+"</b> <br> Distance: "+Math.round(100*(62137e-8*e.segments[j].distance))/100+" miles <br> Elevation: "+Math.round(3.28084*e.segments[j].elev_difference)+" ft").addTo(p)}})});p.on("load",()=>{const a=p.getBounds()._southWest.lat,b=p.getBounds()._southWest.lng,c=p.getBounds()._northEast.lat,d=p.getBounds()._northEast.lng;i(a,b,c,d)}),p.on("dragend",()=>{const a=p.getBounds()._southWest.lat,b=p.getBounds()._southWest.lng,c=p.getBounds()._northEast.lat,d=p.getBounds()._northEast.lng;i(a,b,c,d)});var q;p.on("contextmenu",function(a){var b=a.latlng,c=L.popup().setLatLng(b).setContent("<a class=\"waves-effect waves-light btn meeting-point\" style=\"color: white; background-color: #eb401a;\" name=\"meeting-point\" id=\"meeting-point\">Set Meeting Point</a>").openOn(p);const d=document.getElementById("meeting-point");d&&d.addEventListener("click",()=>{p.hasLayer(q)&&p.removeLayer(q),l=b.lat.toString()+","+b.lng.toString(),p.closePopup();var a=L.icon({iconUrl:"https://cdn2.iconfinder.com/data/icons/map-locations-filled-pixel-perfect/64/pin-map-location-26-512.png",iconSize:[40,40]});q=L.marker([b.lat,b.lng],{icon:a}),p.addLayer(q)})});let n=[];const o=a=>{if(0<n.length){const b=n[n.length-1].x;for(let c,d=0;d<a[1].data.length;d++)c=Math.round(100*(62137e-8*a[1].data[d]))/100+b,n.push({x:c,y:Math.round(3.28084*a[2].data[d])})}else for(let b=0;b<a[1].data.length;b++)n.push({x:Math.round(100*(62137e-8*a[1].data[b]))/100,y:Math.round(3.28084*a[2].data[b])});for(let b=0;b<a[2].data.length;b++)a[2].data[b]>a[2].data[b+1]?k+=a[2].data[b]-a[2].data[b+1]:a[2].data[b]<a[2].data[b+1]&&(j+=a[2].data[b+1]-a[2].data[b]);e.textContent=Math.round(3.28084*j)+" ft",f.textContent=Math.round(3.28084*k)+" ft",renderChart()};removeGraphData=a=>{for(let b=a[1].data.length;0<b;b--)n.pop();for(let b=0;b<a[2].data.length;b++)a[2].data[b]>a[2].data[b+1]?k-=a[2].data[b]-a[2].data[b+1]:a[2].data[b]<a[2].data[b+1]&&(j-=a[2].data[b+1]-a[2].data[b]);e.textContent=Math.round(3.28084*j)+" ft",f.textContent=Math.round(3.28084*k)+" ft",renderChart()},renderChart=()=>{var a=new CanvasJS.Chart("chartContainer",{animationEnabled:!0,title:{},toolTip:{content:"Distance: {x} miles <br> Elevation: {y} feet"},axisY:{suffix:"ft",gridThickness:0},axisX:{suffix:"miles"},data:[{type:"splineArea",lineThickness:3,color:"#EBAF1A",dataPoints:n,markerType:"none"}]});a.render()}}$("#friendSearch").on("click",()=>{let b=document.getElementById("searchList");$(b).empty();const c=$("#first_name").val(),d=$("#last_name").val();fetch(`/profile/userSearch/${c}&${d}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(a=>{a.json().then(c=>{for(let d=0;d<c.length;d++){let e=document.createElement("li"),f=document.createElement("img"),g=document.createElement("span"),h=document.createElement("a"),a=document.createElement("i");h.classList.add("hoverable","btn-floating","btn-large","addUser","secondary-content"),a.classList.add("fas","fa-user-plus"),a.setAttribute("id","addUser"),a.setAttribute("data-value",c[d].user_strava_id),h.appendChild(a),e.classList.add("collection-item","avatar","valign-wrapper"),f.classList.add("circle"),f.setAttribute("src",c[d].user_photo),g.classList.add("title"),g.textContent=c[d].user_first+" "+c[d].user_last,e.appendChild(f),e.appendChild(g),e.appendChild(h),b.appendChild(e),$(document).on("click",`[data-value=${c[d].user_strava_id}]`,function(){this.parentElement.classList.add("disabled"),n.push($(this).attr("data-value"))})}})})});const r=document.getElementById("firstModalButton");r.addEventListener("click",a=>{if(0===l){M.toast({html:"Please pick a meeting location by right clicking on the map",classes:"rounded"}),function(a){a.stopPropagation(),a.preventDefault()}(a)}});const s=document.getElementById("save-activity"),t=document.getElementById("activity_name"),u=document.getElementById("user_id"),v=document.getElementById("user_strava_id");u.style.display="none",v.style.display="none",s&&s.addEventListener("click",a=>{0===l&&alert("Please pick a meeting location by right clicking on the map"),n.push(v.textContent);const b=h.toString();a.preventDefault();const c={activity_type:"biking",activity_segments:b,total_distance:g,total_elevationGain:Math.round(3.28084*j),total_elevationLoss:Math.round(3.28084*k),activity_name:$("#activityName").val().trim(),activity_desc:$("#activityDesc").val().trim(),activity_date:moment($(".datepicker").val()).format("YYYY-MM-DD"),activity_time:moment($(".timepicker").val(),"HH:mm a").format("HH:mm:ss"),activity_gear:"",activity_meeting_location:l,activity_participants:n.toString(),userId:u.textContent};console.log(c),fetch("/profile/api/createActivity",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)})})});